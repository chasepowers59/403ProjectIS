<%- include('partials/header') %>

    <nav class="navbar navbar-expand-lg navbar-antigravity mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/dashboard">
                <img src="/images/team_logo.jpg" alt="Team Logo" style="height: 40px; border-radius: 5px;">
                <span>BYU Information Systems Slack Channels</span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <form class="d-flex" action="/search" method="GET">
                    <input class="form-control-antigravity me-2" type="search" name="q" placeholder="Search events..."
                        value="<%= searchQuery || '' %>" style="min-width: 200px;">
                    <button class="btn-outline-antigravity" type="submit">Search</button>
                </form>
                <span class="navbar-text text-muted-antigravity">
                    Hello, <strong style="color: var(--neon-cyan);">
                        <%= user.name %>
                    </strong>
                </span>
                <a href="/logout" class="btn-outline-antigravity">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Control Center -->
        <div class="control-center mb-5">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <h4 class="mb-0 text-white fw-bold">Dashboard</h4>
                    <div class="control-divider"></div>
                    <a href="/calendar" class="btn-outline-antigravity btn-sm">
                        üìÖ Calendar
                    </a>
                    <button class="btn-antigravity btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                        + New Event
                    </button>
                </div>

                <div class="control-group">
                    <div class="d-flex align-items-center gap-2">
                        <select id="syncChannelSelect" class="form-select-antigravity form-select-sm"
                            style="width: 200px;">
                            <option value="">All Channels (Slow)</option>
                            <% if (typeof channels !=='undefined' && channels && channels.length> 0) { %>
                                <% channels.forEach(channel=> { %>
                                    <option value="<%= channel.id %>">
                                        <%= channel.name %>
                                    </option>
                                    <% }); %>
                                        <% } %>
                        </select>
                        <button id="syncBtn" class="btn-outline-antigravity btn-sm" onclick="syncData()">
                            üîÑ Sync
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Grid -->
        <div class="row g-4">
            <% const approvedEvents=events.filter(e=> e.status === 'approved');
                const rejectedEvents = events.filter(e => e.status === 'rejected');
                const pendingEvents = events.filter(e => e.status !== 'approved' && e.status !== 'rejected');
                %>

                <% if (events.length===0) { %>
                    <div class="col-12">
                        <div class="empty-state glass-card-static">
                            <div class="empty-state-icon">üìÖ</div>
                            <h3>No events found</h3>
                            <p>Sync with Slack or add an event manually to get started.</p>
                            <button class="btn-antigravity mt-3" data-bs-toggle="modal" data-bs-target="#addEventModal">
                                Create First Event
                            </button>
                        </div>
                    </div>
                    <% } else { %>

                        <!-- APPROVED SECTION -->
                        <% if (approvedEvents.length> 0) { %>
                            <div class="col-12 mt-4 mb-2">
                                <h4 class="text-success border-bottom pb-2"
                                    style="border-color: rgba(40, 167, 69, 0.3) !important;">
                                    ‚úÖ Approved
                                </h4>
                            </div>
                            <% approvedEvents.forEach((event, index)=> { %>
                                <div class="col-md-6 col-lg-4">
                                    <div class="event-card glass-card h-100"
                                        style="--card-index: <%= index %>; padding: 1.5rem;">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <span class="badge bg-success">
                                                <%= event.status %>
                                            </span>
                                            <small class="text-muted-antigravity" style="font-size: 0.75rem;">
                                                #<%= event.id %>
                                            </small>
                                        </div>

                                        <h5 class="card-title text-white">
                                            <%= event.title %>
                                        </h5>

                                        <div class="card-meta">
                                            <span>üìÖ
                                                <% const dateObj=new Date(event.start_time); const
                                                    isValidDate=!isNaN(dateObj.getTime()); %>
                                                    <%= isValidDate ? dateObj.toLocaleString('en-US', { weekday: 'short'
                                                        , month: 'short' , day: 'numeric' , hour: 'numeric' ,
                                                        minute: '2-digit' }) : 'Date TBD' %>
                                            </span>
                                        </div>

                                        <div class="card-meta">
                                            <span>#Ô∏è‚É£ <%= event.source_channel || 'Unknown Channel' %>
                                            </span>
                                        </div>

                                        <div class="card-actions">
                                            <button class="btn-icon btn-edit" data-bs-toggle="modal"
                                                data-bs-target="#editEventModal<%= event.id %>" title="Edit">
                                                ‚úèÔ∏è
                                            </button>
                                            <form action="/events/delete/<%= event.id %>" method="POST" class="d-inline"
                                                onsubmit="return confirm('Are you sure you want to delete this event?');">
                                                <button type="submit" class="btn-icon btn-delete" title="Delete">
                                                    üóëÔ∏è
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } %>

                                        <!-- REJECTED SECTION -->
                                        <% if (rejectedEvents.length> 0) { %>
                                            <div class="col-12 mt-4 mb-2">
                                                <h4 class="text-danger border-bottom pb-2"
                                                    style="border-color: rgba(220, 53, 69, 0.3) !important;">
                                                    ‚ùå Rejected
                                                </h4>
                                            </div>
                                            <% rejectedEvents.forEach((event, index)=> { %>
                                                <div class="col-md-6 col-lg-4">
                                                    <div class="event-card glass-card h-100"
                                                        style="--card-index: <%= index %>; padding: 1.5rem;">
                                                        <div
                                                            class="d-flex justify-content-between align-items-start mb-3">
                                                            <span class="badge bg-danger">
                                                                <%= event.status %>
                                                            </span>
                                                            <small class="text-muted-antigravity"
                                                                style="font-size: 0.75rem;">
                                                                #<%= event.id %>
                                                            </small>
                                                        </div>

                                                        <h5 class="card-title text-white">
                                                            <%= event.title %>
                                                        </h5>

                                                        <div class="card-meta">
                                                            <span>üìÖ
                                                                <% const dateObj=new Date(event.start_time); const
                                                                    isValidDate=!isNaN(dateObj.getTime()); %>
                                                                    <%= isValidDate ? dateObj.toLocaleString('en-US', {
                                                                        weekday: 'short' , month: 'short' ,
                                                                        day: 'numeric' , hour: 'numeric' ,
                                                                        minute: '2-digit' }) : 'Date TBD' %>
                                                            </span>
                                                        </div>

                                                        <div class="card-meta">
                                                            <span>#Ô∏è‚É£ <%= event.source_channel || 'Unknown Channel' %>
                                                            </span>
                                                        </div>

                                                        <div class="card-actions">
                                                            <button class="btn-icon btn-edit" data-bs-toggle="modal"
                                                                data-bs-target="#editEventModal<%= event.id %>"
                                                                title="Edit">
                                                                ‚úèÔ∏è
                                                            </button>
                                                            <form action="/events/delete/<%= event.id %>" method="POST"
                                                                class="d-inline"
                                                                onsubmit="return confirm('Are you sure you want to delete this event?');">
                                                                <button type="submit" class="btn-icon btn-delete"
                                                                    title="Delete">
                                                                    üóëÔ∏è
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% }) %>
                                                    <% } %>

                                                        <!-- PENDING SECTION (Grouped by Channel) -->
                                                        <% if (pendingEvents.length> 0) { %>
                                                            <div class="col-12 mt-5 mb-2">
                                                                <h4 class="text-warning border-bottom pb-2"
                                                                    style="border-color: rgba(255, 193, 7, 0.3) !important;">
                                                                    ‚è≥ Pending Review
                                                                </h4>
                                                            </div>
                                                            <% let currentChannel=null; %>
                                                                <% pendingEvents.forEach((event, index)=> {
                                                                    %>
                                                                    <% if (event.source_channel !==currentChannel) { %>
                                                                        <% currentChannel=event.source_channel; %>
                                                                            <div class="col-12 mt-4 mb-2">
                                                                                <h5 class="text-white border-bottom pb-2"
                                                                                    style="border-color: rgba(255,255,255,0.1) !important; margin-left: 1rem;">
                                                                                    <span
                                                                                        class="badge bg-secondary me-2">#</span>
                                                                                    <%= currentChannel
                                                                                        || 'Unknown Channel' %>
                                                                                </h5>
                                                                            </div>
                                                                            <% } %>
                                                                                <div class="col-md-6 col-lg-4">
                                                                                    <div class="event-card glass-card h-100"
                                                                                        style="--card-index: <%= index %>; padding: 1.5rem;">
                                                                                        <div
                                                                                            class="d-flex justify-content-between align-items-start mb-3">
                                                                                            <span
                                                                                                class="badge bg-warning">
                                                                                                <%= event.status %>
                                                                                            </span>
                                                                                            <small
                                                                                                class="text-muted-antigravity"
                                                                                                style="font-size: 0.75rem;">
                                                                                                #<%= event.id %>
                                                                                            </small>
                                                                                        </div>

                                                                                        <h5
                                                                                            class="card-title text-white">
                                                                                            <%= event.title %>
                                                                                        </h5>

                                                                                        <div class="card-meta">
                                                                                            <span>üìÖ
                                                                                                <% const dateObj=new
                                                                                                    Date(event.start_time);
                                                                                                    const
                                                                                                    isValidDate=!isNaN(dateObj.getTime());
                                                                                                    %>
                                                                                                    <%= isValidDate ?
                                                                                                        dateObj.toLocaleString('en-US',
                                                                                                        {
                                                                                                        weekday: 'short'
                                                                                                        , month: 'short'
                                                                                                        , day: 'numeric'
                                                                                                        ,
                                                                                                        hour: 'numeric'
                                                                                                        ,
                                                                                                        minute: '2-digit'
                                                                                                        }) : 'Date TBD'
                                                                                                        %>
                                                                                            </span>
                                                                                        </div>

                                                                                        <div class="card-meta">
                                                                                            <span>#Ô∏è‚É£ <%=
                                                                                                    event.source_channel
                                                                                                    || 'Unknown Channel'
                                                                                                    %>
                                                                                            </span>
                                                                                        </div>

                                                                                        <div class="card-actions">
                                                                                            <button
                                                                                                class="btn-icon btn-edit"
                                                                                                data-bs-toggle="modal"
                                                                                                data-bs-target="#editEventModal<%= event.id %>"
                                                                                                title="Edit">
                                                                                                ‚úèÔ∏è
                                                                                            </button>
                                                                                            <form
                                                                                                action="/events/delete/<%= event.id %>"
                                                                                                method="POST"
                                                                                                class="d-inline"
                                                                                                onsubmit="return confirm('Are you sure you want to delete this event?');">
                                                                                                <button type="submit"
                                                                                                    class="btn-icon btn-delete"
                                                                                                    title="Delete">
                                                                                                    üóëÔ∏è
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <% }) %>
                                                                                    <% } %>

                                                                                        <% } %>
        </div>

        <!-- Hidden Analysis Panel -->
        <div id="analysisPanel" style="display: none;" class="mt-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="card-title-glow mb-0">
                    üß†
                    Slack Activity
                    Analyzer</h3>
                <div class="d-flex align-items-center gap-2">
                    <div id="analysisLoading" style="display: none;" class="text-muted-antigravity me-2">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Analyzing...
                    </div>
                    <button id="analyzeBtn" onclick="loadAnalysis()" class="btn-antigravity btn-sm">
                        üîÑ Reload
                        Analysis
                        Data
                    </button>
                </div>
            </div>

            <div class="glass-card p-4 mb-4">
                <h5 class="text-white mb-3">
                    Summary
                </h5>
                <p id="analysisSummary" class="text-muted-antigravity mb-0" style="line-height: 1.6;">
                    Click "Run
                    Analysis" to
                    generate
                    a summary of
                    recent Slack
                    activity.
                </p>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <h5 class="text-white mb-3">
                        Recent
                        Highlights
                    </h5>
                    <div id="eventsTimeline" class="d-flex flex-column gap-3">
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="text-white mb-3">
                        Trending
                        Topics</h5>
                    <div id="topKeywordsList" class="d-flex flex-wrap gap-2">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content modal-content-antigravity">
                <form action="/events" method="POST">
                    <div class="modal-header-antigravity">
                        <h5 class="modal-title-antigravity">
                            Add
                            New
                            Event
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body-antigravity">
                        <div class="mb-3">
                            <label class="form-label"
                                style="color: var(--text-primary); font-weight: 500;">Title</label>
                            <input type="text" name="title" class="form-control-antigravity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: var(--text-primary); font-weight: 500;">Date</label>
                            <input type="datetime-local" name="start_time" class="form-control-antigravity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: var(--text-primary); font-weight: 500;">Source
                                Channel</label>
                            <input type="text" name="source_channel" class="form-control-antigravity"
                                placeholder="e.g. #general">
                        </div>
                    </div>
                    <div class="modal-footer-antigravity">
                        <button type="button" class="btn-outline-antigravity" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn-antigravity">Create
                            Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Modals -->
    <% events.forEach((event)=>
        { %>
        <div class="modal fade" id="editEventModal<%= event.id %>" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content modal-content-antigravity">
                    <form action="/events/update/<%= event.id %>" method="POST">
                        <div class="modal-header-antigravity">
                            <h5 class="modal-title-antigravity">
                                Edit
                                Event
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body-antigravity">
                            <div class="mb-3">
                                <label class="form-label"
                                    style="color: var(--text-primary); font-weight: 500;">Title</label>
                                <input type="text" name="title" class="form-control-antigravity"
                                    value="<%= event.title %>" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"
                                    style="color: var(--text-primary); font-weight: 500;">Date</label>
                                <input type="datetime-local" name="start_time" class="form-control-antigravity"
                                    value="<%= event.start_time && !isNaN(new Date(event.start_time).getTime()) ? new Date(event.start_time).toISOString().slice(0, 16) : '' %>"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: var(--text-primary); font-weight: 500;">Source
                                    Channel</label>
                                <input type="text" name="source_channel" class="form-control-antigravity"
                                    value="<%= event.source_channel %>" placeholder="e.g. #general">
                            </div>
                            <div class="mb-3">
                                <label class="form-label"
                                    style="color: var(--text-primary); font-weight: 500;">Status</label>
                                <select name="status" class="form-select-antigravity">
                                    <option value="pending" <%=event.status==='pending' ? 'selected' : '' %>
                                        >Pending
                                    </option>
                                    <option value="approved" <%=event.status==='approved' ? 'selected' : '' %>
                                        >Approved
                                    </option>
                                    <option value="rejected" <%=event.status==='rejected' ? 'selected' : '' %>
                                        >Rejected
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer-antigravity">
                            <button type="button" class="btn-outline-antigravity" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn-antigravity">Save
                                changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <% }) %>

            <script>
                async function handleFetchResponse(response) {
                    if (response.redirected) {
                        window.location.href = response.url;
                        return null;
                    }

                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") === -1) {
                        const text = await response.text();
                        if (text.includes("<!DOCTYPE html>")) {
                            window.location.reload();
                            return null;
                        }
                        throw new Error("Server returned non-JSON response: " + text.substring(0, 100));
                    }

                    return await response.json();
                }

                async function syncData() {
                    const btn = document.getElementById('syncBtn');
                    const select = document.getElementById('syncChannelSelect');
                    const channelId = select.value;
                    const channelName = select.options[select.selectedIndex].text;

                    btn.disabled = true;
                    btn.innerText = `üîÑ Syncing ${channelName}...`;

                    try {
                        const response = await fetch('/refresh-data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ channelId })
                        });

                        const result = await handleFetchResponse(response);
                        if (!result) return;

                        if (result.success) {
                            window.location.reload();
                        } else {
                            alert('Sync failed: ' + (result.error || 'Unknown error'));
                            btn.disabled = false;
                            btn.innerText = 'üöÄ Sync Now';
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Sync failed: ' + err.message);
                        btn.disabled = false;
                        btn.innerText = 'üöÄ Sync Now';
                    }
                }

                function renderAnalysis(data) {
                    const panel = document.getElementById('analysisPanel');
                    panel.style.display = 'block';

                    // Summary
                    document.getElementById('analysisSummary').innerText = data.summary || 'No summary available.';

                    // Keywords
                    const keywordsList = document.getElementById('topKeywordsList');
                    keywordsList.innerHTML = '';
                    if (data.top_keywords) {
                        data.top_keywords.forEach(keyword => {
                            const span = document.createElement('span');
                            span.className = 'badge glass-card-static text-white border border-secondary';
                            span.style.padding = '0.5em 1em';
                            span.innerText = `#${keyword}`;
                            keywordsList.appendChild(span);
                        });
                    }

                    // Events
                    const eventsList = document.getElementById('eventsTimeline');
                    eventsList.innerHTML = '';
                    if (data.events) {
                        data.events.forEach(evt => {
                            const div = document.createElement('div');
                            div.className = 'glass-card p-3';
                            div.style.borderLeft = '4px solid var(--neon-cyan)';

                            const dateStr = evt.timestamp ? new Date(evt.timestamp).toLocaleString() : 'Unknown Date';
                            const user = evt.user || 'Unknown User';
                            const channel = evt.channel || 'Unknown Channel';
                            const text = evt.text || '';

                            div.innerHTML = `
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-primary">üí¨ ${user}</span>
                                        <small class="text-muted-antigravity">${dateStr}</small>
                                    </div>
                                    <span class="badge bg-secondary">#${channel}</span>
                                </div>
                                <p class="mb-0 text-white" style="font-size: 0.95rem;">${text}</p>
                            `;
                            eventsList.appendChild(div);
                        });
                    }
                }

                async function runAnalysis() {
                    const btn = document.getElementById('analyzeBtn');
                    const loading = document.getElementById('analysisLoading');
                    const panel = document.getElementById('analysisPanel');

                    btn.disabled = true;
                    // panel.style.display = 'none'; // Don't hide the whole panel, just show loading
                    loading.style.display = 'block';

                    try {
                        const response = await fetch('/analyzeSlackDump', { method: 'POST' });

                        const result = await handleFetchResponse(response);
                        if (!result) return;

                        if (result.success) {
                            renderAnalysis(result.data);
                        } else {
                            alert('Analysis failed: ' + (result.error || 'Unknown error'));
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error: ' + err.message);
                    } finally {
                        btn.disabled = false;
                        loading.style.display = 'none';
                    }
                }

                async function loadAnalysis() {
                    try {
                        const response = await fetch(`/data/slack_analysis.json?t=${Date.now()}`);
                        if (response.ok) {
                            const contentType = response.headers.get("content-type");
                            if (contentType && contentType.includes("application/json")) {
                                const data = await response.json();
                                renderAnalysis(data);
                            }
                        }
                    } catch (err) {
                        console.log('No existing analysis found or error loading it.');
                    }
                }

                window.onload = function () {
                    loadAnalysis();
                };
            </script>
            </body>

            </html>